From 1e5cf3b5940297b54d654de7ab9981b011777023 Mon Sep 17 00:00:00 2001
From: Ollama <hello@ollama.com>
Date: Tue, 28 Jan 2025 23:05:25 -0800
Subject: [PATCH] vulkan

---
 CMakeLists.txt                     | 13 +++++++++++++
 ml/backend/ggml/ggml/.rsync-filter |  3 +++
 2 files changed, 16 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 19d9bd8f..05f8e2c4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -110,3 +110,16 @@ if(CMAKE_HIP_COMPILER)
         endforeach()
     endif()
 endif()
+
+find_package(Vulkan)
+if(Vulkan_FOUND)
+    add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/ml/backend/ggml/ggml/src/ggml-vulkan)
+    set(OLLAMA_VULKAN_INSTALL_DIR ${OLLAMA_INSTALL_DIR}/vulkan)
+    install(TARGETS ggml-vulkan
+        RUNTIME_DEPENDENCIES
+            PRE_INCLUDE_REGEXES vulkan
+            PRE_EXCLUDE_REGEXES ".*"
+        RUNTIME DESTINATION ${OLLAMA_VULKAN_INSTALL_DIR} COMPONENT Vulkan
+        LIBRARY DESTINATION ${OLLAMA_VULKAN_INSTALL_DIR} COMPONENT Vulkan
+    )
+endif()
diff --git a/ml/backend/ggml/ggml/.rsync-filter b/ml/backend/ggml/ggml/.rsync-filter
index c5acbe49..09d67f27 100644
--- a/ml/backend/ggml/ggml/.rsync-filter
+++ b/ml/backend/ggml/ggml/.rsync-filter
@@ -12,6 +12,8 @@ include src/ggml-cuda/
 include src/ggml-cuda/template-instances/
 include src/ggml-hip/
 include src/ggml-metal/
+include src/ggml-vulkan/
+include src/ggml-vulkan/vulkan-shaders
 include *.c
 include *.h
 include *.cpp
@@ -19,4 +21,5 @@ include *.cu
 include *.cuh
 include *.m
 include *.metal
+include *.comp
 exclude *
-- 
2.47.1
